<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="p.minn.privilege.repository.LogDao">

	<select id="getTotal" resultType="java.lang.Integer">
		select count(ol.id) from operator_log ol ,user u where ol.user_id=u.id
		<if test="extParam.operatorname!=null and extParam.operatorname!=''"> and u.name like '${extParam.operatorname}%'</if>
		<if test="extParam.resname!=null and extParam.resname!=''"> and ol.res_id like #{extParam.resname}</if>
		<if test="extParam.signature!=null and extParam.signature!=''"> and ol.signature = '${extParam.signature}'</if>
		<if test="extParam.changeid!=null and extParam.changeid!=''"> and exists(select * from operator_log_detail where
			name='common_id' and operator_log_id=ol.id and
			val=${extParam.changeid})</if>

	</select>

	<select id="query" resultType="java.util.HashMap">
		select ol.id,ol.user_ip,date_format(ol.operator_date,'%Y-%c-%d
		%H:%i:%s') as operator_date,ol.signature,
		u.name as operatorname,
		(select name_${lang} from v_dictionary where mkey='RESOURCECODE' and
		val=ol.res_id) as resname
		from operator_log ol ,user u where ol.user_id=u.id
		<if test="extParam.operatorname!=null and extParam.operatorname!=''"> and u.name like '${extParam.operatorname}%'</if>
		<if test="extParam.resname!=null and extParam.resname!=''"> and ol.res_id = #{extParam.resname}</if>
		<if test="extParam.signature!=null and extParam.signature!=''"> and ol.signature = '${extParam.signature}'</if>
		<if test="extParam.changeid!=null and extParam.changeid!=''"> and exists(select * from operator_log_detail where
			name='common_id' and operator_log_id=ol.id and
			val=${extParam.changeid})</if>
		order by operator_date desc
		limit ${page.startR},${page.endR}
	</select>

	<select id="getLogChangeDetail" resultType="java.util.HashMap">
		select distinct name
		as k,case ld.mkey when '' then ld.val else (select name_${lang} from
		v_dictionary where mkey=ld.mkey and val=ld.val) end as val
		from operator_log_detail ld where ld.operator_log_id=${id}
		order by name desc

	</select>


	<select id="getSignature" resultType="java.util.HashMap">
		select distinct 'RESOURCE'
		as mkey,res_id as id,(select max(name_${lang}) from resource where
		code=res_id) as text from operator_log
		union all
		select distinct 'SIGNATURE' as mkey,signature as id,'' as text
		from operator_log
	</select>

	<insert id="insertOperatorLog" useGeneratedKeys="true"
		keyProperty="id">
		INSERT INTO operator_log (user_id, user_ip,
		operator_date,res_id,signature)
		VALUES (#{userId}, #{userIp},
		sysdate(),#{resId},#{signature})
	</insert>

	<insert id="insertOperatorLogDetail">
		INSERT INTO
		operator_log_detail (operator_log_id, name, val,mkey)
		VALUES
		(${operatorlogid},#{operatorLogDetail.name},
		#{operatorLogDetail.val},#{operatorLogDetail.mkey})
	</insert>



</mapper>